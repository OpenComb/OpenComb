var Class = require("ocClass/lib/Class.js") ;
var View = require("ocPlatform/lib/frontend/mvc/View.js") ;
var Switch = require("ocPlatform/lib/frontend/mvc/Switch.js") ;
var Nut = require("ocPlatform/lib/mvc/controller/Nut.js") ;
var Step = require("step") ;

var Director = module.exports = Class.extend({

	ctor: function($document)
	{
		this.$document = $document || jQuery(document) ;
		this._request = null ;
	}

	, setup: function()
	{
		var director = this ;

		// for link(a tag)
		this.$document.on("click","a[direct]",function(){

			var opt = director.preprocDirect(this) ;

			director.request(
				{
					url: jQuery(this).attr("href")
					, success: function(err,nut)
					{
						if(err)
						{
							throw err ;
						}
						director.fitNut(nut,opt.target) ;
					}
				}
				, opt.uselayout
				, opt.pushHistory
			) ;

			// 取消浏览器默认行为
			return false ;
		}) ;

		// for form
		this.$document.on("submit","form[direct]",function(){

			var opt = director.preprocDirect(this) ;

			director.requestForm(this,function(err,nut){
				if(err)
				{
					throw err ;
				}
				director.fitNut(nut,opt.target) ;
			},opt.uselayout,opt.pushHistory) ;

			// 取消浏览器默认行为
			return false ;
		}) ;


		// state 事件
		window.onpopstate = function(e) {
			console.log(e.state);

			if(e.state)
			{
				director.request({
					url: e.state.url
					, data: e.state.data || {}
					, success: function(err,nut)
					{
						if(err)
						{
							throw err ;
						}

						var view = jQuery(".ocview:not(.oclayout)")[0] ;
						if(view)
						{
							director.fitNut(nut,view) ;
						}
					}
				}) ;
			}
		} ;
		//
		if( window.history.replaceState )
		{
			window.history.replaceState({
				url: location.pathname
				, data: queryStrings(location.search)
			},null) ;
		}
	}

	, preprocDirect: function(ele,data)
	{
		var direct = jQuery(ele).attr("direct") || "lazy" ;
		switch(direct)
		{
			case 'view' :
				var view = jQuery(ele).parents(".ocview")[0] ;
				return {
					target: view
					, uselayout: false
					, pushHistory: jQuery(view).parents(".ocview").eq(0).hasClass("oclayout")
				}

			case 'top' :
				return {
					target: jQuery(jQuery(ele).parents(".oclayout")[0])
						.find(".ocview")[0]
					, uselayout: false
					, pushHistory: true
				}


			case 'lazy' :
			default :
				return {
					target: null
					, uselayout: true
					, pushHistory: true
				}
		}
	}

	, request: function(ajaxOptions,layout,history)
	{
		var director = this ;

		var ajax = ajaxOptions || {} ;
		ajax.dataType = 'json' ;
		ajax.beforeSend = function(req)
		{
			// 一次只请求一个视图
			if(director._request)
			{
				director._request.abort() ;
			}

			// this time
			director._request = req ;
		} ;

		ajax.data = ajax.data || {} ;

		if(!layout)
		{
			ajax.data["@layout"] = false ;
		}

		// sumsign
		if( ajax.data["@layout"]!==false )
		{
			ajax.data["@sumsigns"] = [] ;
			jQuery(".oclayout[sumsign]").each(function(){
				ajax.data["@sumsigns"].push( jQuery(this).attr("sumsign") ) ;
			}) ;
			ajax.data["@sumsigns"] = ajax.data["@sumsigns"].length? ajax.data["@sumsigns"].join(','): undefined ;
		}

		ajax.data["@render"] = false ;

		var callback = ajax.success ;
		ajax.success = function(nut)
		{
			// 请求成功后，增加历史记录
			if( history )
			{
				window.history.pushState && window.history.pushState(
					{
						url: ajax.url
						, data: ajax.data
						, type: ajax.type
					}
					, null
					, ajax.url
				) ;
			}

			Nut.restore(nut,function(err,nut){

				callback && callback(err,nut) ;

				if(err)
				{
					throw err ;
				}
			}) ;
		}

		var cusComplete = ajax.complete ;
		ajax.complete = function()
		{
			// 关闭 loading
			director.hideViewLoading() ;

			cusComplete && cusComplete.apply(this,arguments) ;
		}


		// 现实 loading
		this.showViewLoading() ;

		// 发送请求
		return jQuery.ajax(ajax) ;
	}

	, requestAndSwitch: function(ajax,target)
	{
		var director = this ;
		var callback = ajax.success ;

		ajax.success = function(err,nut){

			if(err)
			{
				throw err ;
			}

			director.fitNut(nut,target,callback) ;
		}

		return this.request(ajax) ;
	}
	, requestForm: function(eleForm,callback,uselayout)
	{
		if(!eleForm)
		{
			throw new Error("Director.requestForm() 参数 eleForm 必须为有效的 form 元素。") ;
			return ;
		}

		var ajax = {
			url: jQuery(eleForm).attr("action")
			, data: {}
			, type: jQuery(eleForm).attr("method") || "GET"
			, contentType: jQuery(eleForm).attr("enctype") || "application/x-www-form-urlencoded"
			, success: callback
		}

		jQuery.each(jQuery(eleForm).serializeArray(),function(i,ipt){
			ajax.data[ipt.name] = ipt.value ;
		}) ;

		this.request( ajax, uselayout ) ;
	}


	/**
	 * 这是一个很牛的函数，它能把服务器返回的 nut ，合理应用到当前视图环境中，不需要你处理任何细节
	 */
	, fitNut: function(nut,target,callback)
	{
		if( !target )
		{
			target = (function findAvailLayout( nut )
			{
				if( nut._children && nut._children.layout )
				{
					var $layout = jQuery("[sumsign="+nut._children.layout.model['$sumsign']+"]") ;
					// bingo !
					if( $layout.length )
					{
						delete nut._children.layout ;

						// just here !
						return $layout.find(".ocview")[0] ;
					}
					else
					{
						return findAvailLayout(nut._children.layout) ;
					}
				}

				return null ;
			}) (nut) ;
		}

		if(!target)
		{
			// 最上层的 ocview
			target = jQuery(".ocview")[0] ;
		}

		// 剥开果壳 :)
		nut.crack(function(err,html){
			if(err)
			{
				console.log(err.message) ;
				console.log(err.stack) ;
				return ;
			}

			// 导入 css
			var assets = nut.view.assets ;
			for(var i=0;i<assets.css.length;i++)
			{
				var selector = "link[href='"+assets.css[i]+"']" ;
				console.log(selector) ;
				if( !jQuery(selector).length )
				{
					jQuery(document.head).append('<link type="text/css" href="'+assets.css[i]+'" rel="stylesheet">') ;
				}
			}

			var $rootview = jQuery(html,document.ownerDocument) ;
			var $views = $rootview.find('.ocview').andSelf() ;

			// 创建视图
			Step(
				function buildViews(){
					var group = this.group() ;

					$views.each(function(){
						View.buildView(this,$oc.shipper,group()) ;
					}) ;
				}
				, function placeInViews(err){
					if(err)
					{
						console.log(err) ;
					}

					// 切换试图
					Switch.replacein($rootview[0],target,this) ;
				}

				, function emitOnshowEvents(err){
					if(err)
					{
						console.log(err) ;
					}

					// 放置到网页上之后 再调用 onshow
					$views.each(function(){
						this.onshow && this.onshow() ;
					}) ;
				}

				, function done(){
					callback && callback(err,nut,view) ;
				}
			)

		}) ;
	}

	, showViewLoading: function()
	{
		this.viewLoadingWidget().show() ;
		return this ;
	}

	, hideViewLoading: function()
	{
		this.viewLoadingWidget().hide() ;
		return this ;
	}

	, viewLoadingWidget: function()
	{
		var $widget = jQuery(".ocview-loading") ;
		return $widget.length? $widget: this.createViewLoading() ;
	}

	, createViewLoading: function()
	{
		var $widget = jQuery('<div class="ocview-loading" style="position: fixed; z-index: 1000"><img src="/ocPlatform/public/style/images/loader_light.gif" ></div>')
						.appendTo(document.body) ;

		function loadingPlace()
		{
			$widget.css({
				left: '10px'
				, top: (jQuery(window).height() - $widget.height() - 25 ) + 'px'
			}) ;
		}

		loadingPlace () ;
		jQuery(window).resize(loadingPlace) ;

		return $widget ;
	}


},{


}) ;


var queryStrings=function(query) {
	var params=query,reg=/(?:^\?|&)(.*?)=(.*?)(?=&|$)/g,temp,args={};
	while((temp=reg.exec(params))!=null) args[temp[1]]=decodeURIComponent(temp[2]);
	return args;
};
