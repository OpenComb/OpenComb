var Class = require("ocClass/lib/Class.js") ;
var Template = require("ocTemplate/lib/Template.js") ;
var TemplateCaches = require("ocTemplate/lib/TemplateCaches.js") ;


module.exports = function(templateClass,parser,generator){
	if( typeof(window)=="undefined" )
	{
		var Platform = module['r'+'equire']("ocPlatform/lib/system/Platform.js") ;
		this.platformConfig = Platform.singleton? Platform.singleton.config: {} ;
	}
	else
	{
		this.platformConfig = {} ;
	}

	TemplateCaches.call( this, templateClass, parser||module.exports.parser, generator||module.exports.generator ) ;
}
module.exports.prototype.__proto__ = TemplateCaches.prototype ;
module.exports.prototype.template = function(filename,callback,from)
{
	var caches = this ;
	return TemplateCaches.prototype.template.call(this,filename,function(err,tpl,cache){
		tpl.filename = filename ;
		callback && callback(err,tpl) ;

		if( caches.platformConfig.dev && !cache )
		{
			tpl.watching() ;
		}
	},from) ;
}
// Parser ------------

var Parser = require("ocTemplate/lib/Parser.js") ;
var htmlParserConfig = Class.cloneObject(null,Parser.htmlParserFactoryConfig) ;
htmlParserConfig.stateMachines.StateTag.properties.emptyTags.view = 1 ;
htmlParserConfig.stateMachines.StateTag.properties.emptyTags.assets = 1 ;

module.exports.parser = new Parser(htmlParserConfig) ;


// Generator ------------
var Generator = require("ocTemplate/lib/Generator.js") ;
module.exports.generator = new Generator ;
module.exports.generator.registerShaderDefine(require("./shaders/view.js")) ;
module.exports.generator.registerShaderDefine(require("./shaders/assets.js")) ;



// singleton -----------
module.exports.__defineGetter__('singleton',function(){

	// 推迟到第一次访问的时候创建 singleton 对象
	// 避免在 “初始require链” 中过早创建对象
	if(!module.exports._singleton)
	{
		module.exports._singleton = new module.exports() ;
	}

	return module.exports._singleton ;
}) ;
module.exports.__defineSetter__('singleton',function(instance){
	module.exports._singleton = instance ;
}) ;


module.exports.__SHIPPABLE = true ;