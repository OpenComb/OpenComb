
var Class = require("ocClass/lib/Class.js") ;
var Controller = require("./../mvc/controller/Controller.js") ;
var url = require("url") ;
var assert = require("assert") ;
var path = require("path") ;

module.exports = Class.extend({

	ctor: function(platform){
		this.platform = platform ;
	}

	, route: function(req,rsp,next){

		var urlInfo = url.parse(req.url) ;

		var extname = path.extname(urlInfo.pathname) ;
		if( extname && extname.toLowerCase()!='.js' )
		{
			next() ;
			return ;
		}

		var controllerPath = urlInfo.pathname.substr(1,urlInfo.pathname.length-1) || this._defaultControllerPath ;
		if(!controllerPath)
		{
			next() ;
			return ;
		}

		var router = this ;
		Controller.load(controllerPath,function(err,controller){

			if(err)
			{
				if( typeof err.code!="undefined" && err.code=='MODULE_NOT_FOUND')
				{
					rsp.codeStatus = 404 ;
				}
				else
				{
					rsp.codeStatus = 500 ;
				}
				next() ;

				throw err ;
			}
			else
			{
				rsp.setHeader("Content-Type", "text/html") ;
				rsp.setHeader("Power-by", "OpenComb") ;

				module.exports.buildControllerResponse(rsp) ;
				rsp.pause() ;

				controller.main(req,rsp,router.platform) ;

				rsp.resume() ;
			}
		}) ;
	}

	, _defaultControllerPath: "ocPlatform/lib/mvc/controller/Hello"

},{

	className: "ControllerRouter"

	, buildControllerResponse:	 function(httpRspn){

		if( httpRspn._isControllerResponse )
		{
			return ;
		}

		httpRspn._isControllerResponse = true ;
		httpRspn._locks = 0 ;

		httpRspn.pause = function()
		{
			httpRspn._locks ++ ;
		}
		httpRspn.resume = function()
		{
			assert(httpRspn._locks>=1,"httpRspn._locks must be >0") ;

			if( (--httpRspn._locks)<=0 )
			{
				this.emit("complete") ;
			}
		}

		httpRspn._oriEnd = httpRspn.end ;
		httpRspn.end = function()
		{
			this._oriEnd() ;
		}

		return httpRspn ;

	}
}) ;



